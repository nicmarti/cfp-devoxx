@import play.api.libs.json.Json
@import play.api.libs.json.JsArray
@import play.api.libs.json.JsString
@import play.twirl.api.TemplateMagic.defining
@(speaker: Speaker,
        webuser: Webuser,
        myProposals: List[Proposal],
        totalArchived: Int,
        ratings: Map[Proposal, List[Rating]],
        needsToAcceptTermAndCondition: Boolean)(implicit flash: Flash, lang: Lang, req: RequestHeader)
@import org.apache.commons.lang3.StringUtils
@main(title=Messages("cfp.title"), additionalAssets=List(
    HtmlAsset("https://cdnjs.cloudflare.com/ajax/libs/chosen/1.8.7/chosen.jquery.min.js", Javascript),
    HtmlAsset("https://cdnjs.cloudflare.com/ajax/libs/chosen/1.8.7/chosen.min.css", Stylesheet)
)) {

<div class="row">
                <div class="col-4">
                        <div class="widget-head-color-box navy-bg p-lg text-center">
                            <div class="m-b-md">
                            <h2 class="font-bold no-margins">
                                @webuser.cleanName
                            </h2>
                                <strong>@speaker.company</strong><br>
                                <small>@webuser.email</small>
                            </div>

                        @if(speaker.avatarUrl.isEmpty) {
                            <img src="//www.gravatar.com/avatar/@Webuser.gravatarHash(webuser.email)?s=75" class="img-circle circle-border m-b-md speaker-photo" alt="profile">
                        } else {
                            <img src="@speaker.avatarUrl.get" class="img-circle circle-border m-b-md speaker-photo" alt="profile">
                        }
                        </div>
                    <div class="widget-footer text-center">
                        <a href="@routes.CallForPaper.editProfile()" class="btn btn-sm btn-primary"><i class="fas fa-edit"></i> @Html(Messages("edit.profile"))</a>
                    </div>
                </div>
                <div class="col-8">
                    <div class="widget-text-box">
                        <h4 class="media-heading">@webuser.cleanName</h4>
                        <div class="speaker-bio-quote">@Html(speaker.bioAsHtml)</div>
                    </div>
                </div>

    <div class="h-25"></div>


    <div class="col-12 mb-5">
          <h3><i class="fas fa-tasks"></i> @Messages("your.submission")</h3>

            @flash.get("error").map { errorMsg =>
                <div class="alert alert-danger alert-dismissable">
                    <strong>Error :</strong>
                    @errorMsg
                </div>
            }

            @flash.get("success").map { successMsg =>
                <div class="alert alert-success alert-dismissable">
                @successMsg
                </div>
            }

            @flash.get("warning").map { warnMsg =>
                <div class="alert alert-warning alert-dismissable">
                @warnMsg
                </div>
            }
            @flash.get("deleted").map { proposalId =>
                <div class="alert alert-warning">
                    @Messages("talk.deleted") <br>
                    <a href="@routes.CallForPaper.undeleteProposal(proposalId)" class="btn btn-primary btn-sm"><i class="fas fa-undo"></i> @Messages("talk.deleted2") @proposalId</a>
                </div>
            }

            @if(needsToAcceptTermAndCondition) {
                <div class="alert alert-warning alert-dismissable">
                    <strong>Warning :</strong> You have not yet accepted the Devoxx's Terms & Conditions.
                    <a href="@routes.ApproveOrRefuse.acceptTermsAndConditions()">Accept Terms & Conditions</a>
                </div>
            }

            @if(myProposals.isEmpty) {
                <div class="alert alert-info">
                @Messages("no.proposal")
                </div>
            }

            @if(ConferenceDescriptor.isCFPOpen) {
                <div class="mb-3">
                    <a href="@routes.CallForPaper.newProposal" class="btn btn-primary"><i class="fas fa-lightbulb"></i> @Html(Messages("new.proposal"))</a>
                </div>

                <div class="alert alert-info">
                  @Messages("proposal.limit", ConferenceDescriptor.maxProposals(), ConferenceDescriptor.ConferenceProposalConfigurations.concernedByCountQuotaRestrictionAndNotHidden.map(pc => Messages(ProposalType.byProposalConfig(pc).simpleLabel)).mkString(", "))
                </div>
            } else {
                <div class="panel panel-success">
                    <div class="card-header">Information</div>
                    <div class="card-body">@Messages("cfp.isClosed.expl")</div>
                </div>
            }

        <div class="row">
        @myProposals.sortBy(_.id).map{proposal=>
            <div class="col-xs-12 col-md-4 col-lg-4 card-deck">
                @tags.callForPaper.showProposal(proposal)
            </div>
        }
        </div>

        <div class="row">
             @if(ratings.nonEmpty) {
                    <div class="col-12">
                        <h3><i class="fas fa-chart-bar"></i> @Messages("hfspk.rating.title")</h3>
                        <p>@Messages("hfspk.rating.desc")</p>
                        <table class="table table-bordered table-striped">
                            <thead>
                                <tr>
                                    <th>@Messages("table.pres.title")</th>
                                    <th>@Messages("table.pres.rating")</th>
                                    <th>@Messages("table.pres.comment")</th>
                                </tr>
                            </thead>
                            <tbody>
                            @ratings.map { case (prop: Proposal, allRatings: List[Rating]) =>
                            <tr>
                                <td>
                                    @StringUtils.abbreviate(prop.title, 70)</td>
                                <td>
                                    @library.Stats.average(allRatings.flatMap(_.details.map(_.rating.toDouble))) <br>
                                    @allRatings.size vote(s)
                                </td>
                                <td>

                                @allRatings.map { r: Rating =>
                                    @r.details.map { details =>
                                            @if(details.review.isEmpty){
                                                <span class="badge badge-success">Rating : </span> @details.rating
                                            }else {
                                                <span class="badge badge-success">Rating detailed : </span>
                                                @details.review.map { d =>
                                                    @details.aspect = @details.rating <em>@d</em>
                                                }
                                            }
                                                <hr>
                                    }
                                }
                            </td>
                            </tr>
                            }
                            </tbody>
                        </table>
                    </div>
                }
        </div>

    </div>

    @if(Webuser.isMember(webuser.uuid, "cfp")) {
        @defining(NotificationUserPreference.load(webuser.uuid)) { notificationUserPref =>
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3><i class="fas fa-envelope"></i> @Messages("email.notifications.label")</h3>
                </div>
                <div class="card">
                @helper.form(routes.CallForPaper.saveNotificationPreferences()) {
                    <table class="table">
                        <tbody>
                            <tr>
                                <td colspan="2">
                                    <h4>@Messages("email.notifications.autowatch.title")</h4>
                                    <em>@Messages("email.notifications.autowatch.desc1")</em>
                                    <br/>
                                    <em>@Messages("email.notifications.autowatch.desc2")</em>

                                    <hr class="borderless"/>

                                    <label for="autoWatchKind">@Messages("email.notifications.autowatch.title")</label>
                                    <select id="autoWatchKind" name="autowatchId" class="chosen" onchange="autoWatchUpdatedTo(this.value)">
                                        <option></option>
                                        @AutoWatch.allAutowatches.map { autowatch =>
                                            <option value="@autowatch.id" @if(notificationUserPref.autowatchId==autowatch.id){ selected="true" }>@Messages(autowatch.labelI18nKey)</option>
                                        }
                                    </select>
                                    <hr class="borderless"/>
                                    <input type="radio" name="autoWatchTracks" id="autoWatchAllTracks" onchange="autoWatchAllTracksSelected()" value="autoWatchAllTracks" @if(notificationUserPref.autowatchFilterForTrackIds.isEmpty){ checked="true" }>
                                    <label style="margin-left: 7px; display: inline-block" for="autoWatchAllTracks">@Messages("email.notifications.autowatch.all-tracks")</label>
                                    <br/>
                                    <input type="radio" name="autoWatchTracks" id="autoWatchFilteredTracks" onchange="autoWatchPerTracksSelected()" value="autoWatchFilteredTracks" @if(notificationUserPref.autowatchFilterForTrackIds.isDefined){ checked="true" }>
                                    <label style="margin-left: 7px; display: inline-block" for="autoWatchFilteredTracks">@Messages("email.notifications.autowatch.specific.to-track")</label> :
                                    <select class="chosen" id="autowatchFilterForTrackIds" name="autowatchFilterForTrackIds[]" style="width: 500px" multiple>
                                    @ConferenceDescriptor.ConferenceTracks.ALL.map { track =>
                                        <option value="@track.id" @if(notificationUserPref.autowatchFilterForTrackIds.getOrElse(List()).contains(track.id)){ selected="true" }>@Messages(track.label)</option>
                                    }
                                    </select>
                                </td>
                            </tr>
                            <tr>
                                <td colspan="2">
                                    <h4>@Messages("email.notifications.as.watcher.title")</h4>
                                    <label for="notificationFrequency">@Messages("email.notifications.frequency.label")</label>
                                    <select id="notificationFrequency" name="digestFrequency" class="chosen">
                                        <option></option>
                                        @Digest.selectableDigests.map { digest =>
                                            <option value="@digest.value" @if(notificationUserPref.digestFrequency==digest.value){ selected="true" }>@digest.labelI18nMessage()</option>
                                        }
                                    </select>
                                    <hr class="borderless"/>
                                    <label for="notificationEvents">@Messages("email.notifications.events.label")</label>
                                    <select id="notificationEvents" name="eventIds[]" class="chosen" multiple>
                                    @NotificationEvent.allNotificationEvents.map { notificationEvent =>
                                        @if(notificationEvent.applicableTo(webuser)) {
                                            <option value="@notificationEvent.id" @if(notificationUserPref.eventIds.contains(notificationEvent.id)){ selected="true" }>@Messages(notificationEvent.labelI18nKey)</option>
                                        }
                                    }
                                    </select>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                    <button class="btn btn-success" type="submit">@Messages("email.notifications.save")</button>
                }
                </div>
            </div>

        </div>
        <script>
            $(".chosen").chosen({
                allow_single_deselect: true,
                disable_search: true,
            });
            const eventsSpecificToAutoWatches = [ @NotificationEvent.allNotificationEvents.filter(_.onlyForAutoWatches.nonEmpty).map { notifEvent =>
                @Html(Json.stringify(Json.toJson(Map(
                    "event" -> JsString(notifEvent.id),
                    "onlyForAutoWatches" -> JsArray(notifEvent.onlyForAutoWatches.map{ autoWatches => autoWatches.map{ aw => JsString(aw.id) } }.getOrElse(List()))
                ))))
            } ];
            function autoWatchUpdatedTo(autoWatchVal) {
                const $notificationEvents = $("#notificationEvents");
                eventsSpecificToAutoWatches.forEach(estaw => {
                    const $eventOption = $notificationEvents.find(`option[value='${estaw.event}']`);
                    if(estaw.onlyForAutoWatches.includes(autoWatchVal)) {
                        $eventOption.show();
                        // Auto-selecting the event as well (note that user can manually remove it if he wants)
                        $eventOption.prop('selected', true);
                    } else {
                        $eventOption.hide();
                        // Auto-removing the event as well as chosen wont remove it by itself otherwise
                        $eventOption.prop('selected', false);
                    }
                })
                $notificationEvents.trigger("chosen:updated");
            }
            function autoWatchAllTracksSelected() {
                const $autowatchFilterForTrackIds = $("#autowatchFilterForTrackIds");
                $autowatchFilterForTrackIds.find("option").each((_, optionEl) => $(optionEl).prop('selected', false))

                $autowatchFilterForTrackIds.prop('disabled', true);
                $autowatchFilterForTrackIds.trigger("chosen:updated");
            }
            function autoWatchPerTracksSelected() {
                const $autowatchFilterForTrackIds = $("#autowatchFilterForTrackIds");
                $autowatchFilterForTrackIds.prop('disabled', false);
                $autowatchFilterForTrackIds.trigger("chosen:updated");
            }
        </script>
       }
    }
</div><!-- row -->

}
